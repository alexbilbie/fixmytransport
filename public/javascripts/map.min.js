var map;var markers;var otherMarkers;var stopsById=new Array();var proj=new OpenLayers.Projection("EPSG:4326");var selectControl;var openPopup;var openHover;var segmentStyle={strokeColor:"#CC0000",strokeOpacity:0.2,strokeWidth:4};var segmentSelectedStyle={strokeColor:"#000000",strokeOpacity:0.5,strokeWidth:4};function area_init(){createMap("map");bounds=new OpenLayers.Bounds();markers=new OpenLayers.Layer.Markers("Markers");otherMarkers=new OpenLayers.Layer.Markers("Other Markers");map.addLayer(otherMarkers);map.addLayer(markers);addMarkerList(areaStops,markers,false);addMarkerList(otherAreaStops,otherMarkers,true);centerCoords=new OpenLayers.LonLat(lon,lat);centerCoords.transform(proj,map.getProjectionObject());map.setCenter(centerCoords,zoom);if(findOtherLocations==true){map.events.register("moveend",map,updateLocations)}if(($("#map").width()<mapWidth||$("#map").height()<mapHeight)&&(areaStops.length>0)){map.zoomToExtent(bounds,false)}map.events.register("zoomend",map,function(){if(map.getZoom()==0){map.setCenter(centerCoords,zoom);return}if(map.getZoom()<minZoom){map.zoomTo(minZoom)}if(map.getZoom()>maxZoom){map.zoomTo(maxZoom)}})}function updateLocations(c){var b=map.getZoom();if(b>=minZoomForOtherMarkers){if($("#map-zoom-notice").length>0){$("#map-zoom-notice").fadeOut(500)}for(var a=0;a<otherMarkers.markers.length;a++){otherMarkers.markers[a].display(true)}}else{if($("#map-zoom-notice").length>0){$("#map-zoom-notice").fadeIn(500)}for(var a=0;a<otherMarkers.markers.length;a++){if(!otherMarkers.markers[a].highlight==true){otherMarkers.markers[a].display(false)}}}if(b>=minZoomForOtherMarkers||highlight=="has_content"){center=map.getCenter();center=center.transform(map.getProjectionObject(),proj);url="/locations/"+map.getZoom()+"/"+Math.round(center.lat*1000)/1000+"/"+Math.round(center.lon*1000)/1000+"/"+linkType;params="?height="+$("#map").height()+"&width="+$("#map").width();params=params+"&highlight="+highlight;$.ajax({url:url+params,dataType:"json",success:loadNewMarkers,failure:markerFail})}}function loadNewMarkers(a){newMarkers=a.locations;addMarkerList(newMarkers,otherMarkers,true);newContent=a.issue_content;if($("#issues-in-area").length>0){$("#issues-in-area").html(newContent)}}function markerFail(){}function addMarkerList(e,g,c){var f;for(var b=0;b<e.length;b++){var d=e[b];if(d instanceof Array){for(var a=0;a<d.length;a++){addMarker(d[a],bounds,g,c)}}else{addMarker(d,bounds,g,c)}}}function addMarker(d,c,b,a){stopCoords=pointCoords(d.lon,d.lat);addRouteMarker(stopCoords,c,b,d,a)}function pointCoords(b,a){return new OpenLayers.LonLat(b,a).transform(proj,map.getProjectionObject())}function route_init(l,j){createMap(l);bounds=new OpenLayers.Bounds();var c=new OpenLayers.Layer.Vector("Vector Layer",{projection:proj});var e=new OpenLayers.Layer.Markers("Markers",{projection:proj});map.addLayer(c);map.addLayer(e);addSelectedHandler(c);for(var f=0;f<j.length;f++){var h=j[f];var d=pointCoords(h[0].lon,h[0].lat);var b=pointCoords(h[1].lon,h[1].lat);var a=new OpenLayers.Geometry.Point(d.lon,d.lat);var g=new OpenLayers.Geometry.Point(b.lon,b.lat);var k=[];k.push(a);k.push(g);bounds.extend(a);bounds.extend(g);lineString=new OpenLayers.Geometry.LineString(k);lineFeature=new OpenLayers.Feature.Vector(lineString,{projection:proj},segmentStyle);lineFeature.segment_id=h[2];c.addFeatures([lineFeature])}map.zoomToExtent(bounds,false)}function addSelectedHandler(a){a.events.on({featureselected:segmentSelected,featureunselected:segmentUnselected});selectControl=new OpenLayers.Control.SelectFeature(a,{multiple:false,toggleKey:"ctrlKey",multipleKey:"shiftKey"});map.addControl(selectControl);selectControl.activate()}function segmentSelected(a){segment=a.feature;segment.style=segmentSelectedStyle;this.drawFeature(segment);var b=$("#route_segment_"+segment.segment_id);b.toggleClass("selected");b.find(".check-route-segment").attr("checked","true")}function segmentUnselected(a){segment=a.feature;segment.style=segmentStyle;this.drawFeature(segment);$("#route_segment_"+segment.segment_id).toggleClass("selected")}function createMap(a){OpenLayers.ImgPath="/javascripts/img/";var b={projection:new OpenLayers.Projection("EPSG:900913"),units:"m",numZoomLevels:18,maxResolution:156543.0339,theme:"/javascripts/theme/default/style.css",maxExtent:new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34)};$(".static-map-element").hide();map=new OpenLayers.Map(a,b);var c=new OpenLayers.Layer.Google("Google Streets",{sphericalMercator:true,maxExtent:new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34)});map.addLayer(c)}function stopSelected(){this.icon.imageDiv.style.cursor="wait";document.location=this.url}function stopHovered(){hoverStop(this)}function hoverStop(b){if(openHover){stopUnhovered(openHover.stop);openHover=null}offset=(b.icon.size.h/2);tooltip_position=map.getPixelFromLonLat(b.lonlat).offset(new OpenLayers.Pixel(0,offset+5));tooltip_lonlat=map.getLonLatFromPixel(tooltip_position);var a=new OpenLayers.Popup("activetooltip",tooltip_lonlat,new OpenLayers.Size(100,12),b.name,false);a.contentDisplayClass="tooltip-popup-content";a.displayClass="tooltip-popup";a.backgroundColor="#FFFCCF";a.border="1px solid #CDCDC1";a.div.style.fontSize="1em";a.contentDiv.style.overflow="hidden";a.closeOnMove=true;a.autoSize=true;a.updateSize();b.popup=a;openHover=a;a.stop=b;map.addPopup(a)}function stopUnhovered(){unHoverStop(this)}function unHoverStop(a){if(a!=null&&a.popup!=null){map.removePopup(a.popup)}}function addRouteMarker(b,a,c,h,g){if(stopsById[h.id]==undefined){a.extend(b);var i=new OpenLayers.Size(h.width,h.height);var d=new OpenLayers.Pixel(-(i.w/2),-i.h);var f=new OpenLayers.Icon(h.icon+".png",i,d);f.imageDiv.style.cursor="pointer";var e=new OpenLayers.Marker(b,f);e.url=h.url;e.name=h.description;e.id=h.id;e.highlight=h.highlight;stopsById[h.id]=e;e.events.register("click",e,stopSelected);e.events.register("mouseover",e,stopHovered);e.events.register("mouseout",e,stopUnhovered);c.addMarker(e)}};
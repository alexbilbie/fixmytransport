$(function(){if(geo_position_js.init()){$(".fmt-has-geolocation").each(function(b){var a=$(this).find("input, select").not(":hidden").attr("id")||b;$(this).find("label").after('<div class="geolocate-container" id="geolocate-container-'+a+'"><span class="geolocate-button button" id="geolocate-button-'+a+'">'+$().fmt_translate("shared.geolocate.use_current_location")+"</span></div>");$("#geolocate-button-"+a).click(function(c){doGeolocate(c,a)})})}});function doGeolocate(c,b){c.preventDefault();$("#geolocate-button-"+b).replaceWith("<p class='geolocate-status geolocate-busy' id='geolocate-status-"+b+"'>"+$().fmt_translate("shared.geolocate.fetching")+"</p>");$(".geolocate-container").not("#geolocate-container-"+b).fadeTo("slow",0);$("#geolocate-container-"+b).parent().find(".error").fadeOut("slow");if(geo_position_js.init()){var a=4800;geo_position_js.getCurrentPosition(function(d){if($(".fmt-has-geolocation").size()==2){var e="train";if(document.title.search(/metro/i)!=-1){e="other"}else{if(document.title.search(/ferry/i)!=-1){e="ferry"}}$("#geolocate-status-"+b).text($().fmt_translate("shared.geolocate.loading_"+e));$.getJSON("/request_nearest_stop",{lon:d.coords.longitude,lat:d.coords.latitude,transport_mode:e},function(f){var g=$("#"+b);if(g[0].nodeName.toLowerCase()=="select"){g.replaceWith("<input type='text' id='"+b+"'>");g=$("#"+b)}g.val(f.name);g.closest("form").find("input:text, select").not("#"+b).focus()})}else{if($("#bus_route_form").size()){$("#geolocate-status-"+b).text($().fmt_translate("shared.geolocate.loading_bus"));$.getJSON("/request_nearest_stop",{lon:d.coords.longitude,lat:d.coords.latitude},function(f){$("#"+b).val(f.area);if($("#lat").size()==0){$("#bus_route_form").append("<input type='hidden' name='lat' id='lat'/>")}if($("#lon").size()==0){$("#bus_route_form").append("<input type='hidden' name='lon' id='lon'/>")}if($("#accuracy").size()==0){$("#bus_route_form").append("<input type='hidden' name='accuracy' id='accuracy'/>")}if($("#geo_area_name").size()==0){$("#bus_route_form").append("<input type='hidden' name='geo_area_name' id='geo_area_name'/>")}$("#lat").val(d.coords.latitude);$("#lon").val(d.coords.longitude);$("#accuracy").val(d.coords.accuracy);$("#geo_area_name").val(f.area);if($("#route_number").val()==$("#guidance-route-number").text()){$("#route_number").focus()}})}else{$("#geolocate-status-"+b).text($().fmt_translate("shared.geolocate.loading"));document.location.href=document.location.href+"?lon="+d.coords.longitude+"&lat="+d.coords.latitude}}$("#geolocate-status-"+b).text($("#geolocate-status-"+b).text()+" "+$().fmt_translate("shared.geolocate.loading_done"));$(".geolocate-status").removeClass("geolocate-busy").addClass("geolocate-done");$(".geolocate-container").fadeTo(a,0)},function(e){var d;if(e.code==e.PERMISSION_DENIED){d=$().fmt_translate("shared.geolocate.cancelled")}else{if(e.code==e.POSITION_UNAVAILABLE){d=$().fmt_translate("shared.geolocate.no_lookup")}else{if(e.code==e.TIMEOUT){d=$().fmt_translate("shared.geolocate.no_result")}else{d=$().fmt_translate("shared.geolocate.unknown_error")}}}$("#geolocate-status-"+b).removeClass("geolocate-busy").text(d)},{timeout:10000})}else{$("#geolocate-status-"+b).removeClass("geolocate-busy").text($().fmt_translate("shared.geolocate.cannot_locate"))}};
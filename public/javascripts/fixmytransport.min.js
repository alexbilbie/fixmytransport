$(document).ready(function(){$.ajaxSetup({beforeSend:function(h){h.setRequestHeader("X-CSRF-Token",$("meta[name=csrf-token]").attr("content"))}});if($("#frontpage-problem-scroller").length>0){var s=0;if($("#frontpage-problem-scroller li img").length>0){s=250}$("#frontpage-problem-scroller").children("li").each(function(h){if($(this).height()>s){s=$(this).height()}});$("#frontpage-problem-scroller").children("li").css({height:s});$("#frontpage-problem-scroller li:not(:first)").addClass("hidden").hide();$("#frontpage-problem-scroller li:first").addClass("first");$("#frontpage-problem-scroller li:last").addClass("last");frontpageScroller(5000,2000)}function a(){if($("#tabs").length>0){$("#tabs").tabs();if($("#tabs-bus .tabs-sub-nav").length>0){$("#tabs-bus").tabs()}if($("#tabs-coach .tabs-sub-nav").length>0){$("#tabs-coach").tabs()}if($("#tabs-train .tabs-sub-nav").length>0){$("#tabs-train").tabs()}if($("#tabs-ferry .tabs-sub-nav").length>0){$("#tabs-ferry").tabs()}if($("#tabs-metro .tabs-sub-nav").length>0){$("#tabs-metro").tabs()}v()}}function c(){if($("#operator-tabs").length>0){$("#operator-tabs").tabs();v()}}function v(){var h="childactive-"+$("#tabs-main-nav li.ui-state-active").attr("id");$("#tabs-main-nav").removeClass(function(w,x){return(x.match(/\bchildactive-\S+/g)||[]).join(" ")});$("#tabs-main-nav").addClass(h)}a();c();m();$("#tabs").bind("tabsshow",function(h,w){v()});$("#operator-tabs").bind("tabsshow",function(h,w){v()});$("#RegionMap area").hover(function(){var h=$(this).attr("id");$("#region-list li."+h).addClass("active")},function(){$("#region-list li").removeClass("active")});$(".goto-top").click(function(h){h.preventDefault();$("html, body").animate({scrollTop:0},"slow")});$("#find-stop input, .form-list li input").focus(function(){$(this).parent().addClass("active")});$("#find-stop input, .form-list li input").blur(function(){$(this).parent().removeClass("active")});function d(h){if(h.hasClass("open")){$(".thread-details",h).hide("blind","",1000,function(){h.removeClass("open")})}else{h.addClass("open");$(".thread-details",h).show("blind","",1000)}}$("ul.closed-campaign-thread li").removeClass("open");$("ul#campaign-thread li a.thread-item").click(function(h){h.preventDefault();if(!$(this).hasClass("compact")){d($(this).parent("li"))}});$(".thread-controls .expand-all").click(function(h){h.preventDefault();d($("ul#campaign-thread li:not(:has(.compact))").not(".open"))});$(".thread-controls .collapse-all").click(function(h){h.preventDefault();d($("ul#campaign-thread li.open:not(:has(.compact))"))});function g(h,w){$(h).hide();$(w).autofill({value:$(h).text(),defaultTextColor:"#595454",activeTextColor:"#000000"})}function m(){g("#guidance-name","#stop_name_form #name");g("#guidance-route-number","#bus_route_form #route_number");g("#guidance-area","#bus_route_form #area");g("#guidance-to","#train_route_form #to");g("#guidance-from","#train_route_form #from");g("#guidance-to","#other_route_form #to");g("#guidance-from","#other_route_form #from");g("#guidance-to","#ferry_route_form #to");g("#guidance-from","#ferry_route_form #from")}$("#login-box").dialog({autoOpen:false,show:"fade",hide:"fade",modal:true,width:500,title:"Sign In or Sign Up",beforeClose:function(h,w){$("#login-box form").find("#next_action").remove();$("#login-box .error").html();$("#login-box .error").hide();$("#login-box input[type=text]").val("");$("#login-box input[type=password]").val("")}});$(".auth").click(function(h){h.preventDefault();$(".login-box .pane").hide();$("#login-landing").show();$("#login-box").dialog({title:"Sign In or Sign Up"});$("#login-box").dialog("open");return false});$(".login-box .pane").not("#login-landing").hide();$(".pane #create-account").click(function(h){h.preventDefault();$(".pane:visible").fadeOut(500,function(){$("#login-box").dialog({title:"Create Account"});$("#login-create-account").fadeIn()})});$(".pane #login-to-account").click(function(h){h.preventDefault();$(".pane:visible").fadeOut(500,function(){$("#login-box").dialog({title:"Sign In or Sign Up"});$("#login-landing").fadeIn()})});$(".pane #forgot-password").click(function(h){h.preventDefault();$(".pane:visible").fadeOut(500,function(){$("#login-box").dialog({title:"Reset Password"});$("#login-forgot-password").fadeIn()})});function t(x,w){var h="<b>"+x+"</b><br/>"+w+"<br/>";return h}$(".facebook-trigger").click(function(w){if($(window).width()>600){w.preventDefault();$(".login-box .pane").hide();$("#post-message").empty();var h=t(campaign_data.facebook_post_title,campaign_data.facebook_post_description);$(h).appendTo("#post-message");$("#fb-share").show();$("#login-box").dialog({title:"Facebook"});$("#login-box").dialog("open");return false}});$(".email-trigger").click(function(h){if($(window).width()>600){h.preventDefault();$(".login-box .pane").hide();$("#email-share").show();$("#login-box").dialog({title:"Email"});$("#login-box").dialog("open");return false}});$("#email-share .email-body").click(function(){$(this).select()});function b(){var h={display:"popup",name:"FixMyTransport campaign: "+campaign_data.title,link:campaign_data.url,picture:document.location.protocol+"//"+document.location.host+"/images/facebook-feed-logo.gif",description:campaign_data.facebook_description};return h}function p(h,w){if($(window).width()>600){$(".login-box .pane").hide()}$(w).empty();if(h&&h.post_id){$("<b>Posted on Facebook!</b><br/>Thanks for spreading the word about this campaign!<br/>").appendTo(w)}else{$("<b>Oops &mdash; didn&rsquo;t post on Facebook</b><br/>You cancelled this time...<br/>but please do spread the word about this campaign.<br/>").appendTo(w)}if($(window).width()>600){$("#fb-share").show();$("#login-box").dialog({title:"Facebook"});$("#login-box").dialog("open");$(w).fadeIn()}}$("#fb-post-to-wall").click(function(w){w.preventDefault();var h=b();h.method="feed";h.caption=campaign_data.description;h.message=campaign_data.facebook_message;FB.ui(h,function(x){p(x,"#post-message")});return false});$("#fb-send").click(function(w){w.preventDefault();var h=b();h.method="send";FB.ui(h);return false});$(".advice-trigger").click(function(w){if($(window).width()>600){w.preventDefault();$(".login-box .pane").hide();$("#campaign-update").show();var h=$("#campaign-thread li:last-child .thread-item .num").text();$("#campaign-update-form-modal").append($("<input/>").attr("type","hidden").attr("name","last_thread_index").attr("class","last_thread_index").val(h));$("#login-box").dialog({title:$(".advice-trigger").attr("data-title")});$("#campaign-update-form-modal button[type=submit]").html("Ask for advice");$("#campaign-update-form-modal").append($("<input/>").attr("type","hidden").attr("id","campaign_update_is_advice_request").attr("name","campaign_update[is_advice_request]").val("true"));$("#login-box").dialog("open");return false}});$(".update-trigger").click(function(w){if($(window).width()>600){w.preventDefault();$(".login-box .pane").hide();$("#campaign-update").show();var h=$("#campaign-thread li:last-child .thread-item .num").text();$("#campaign-update-form").append($("<input/>").attr("type","hidden").attr("name","last_thread_index").attr("class","last_thread_index").val(h));$("#login-box").dialog({title:"Update:"});$("#campaign-update-form button[type=submit]").html("Add Update");$("#login-box").dialog("open");return false}});$(".comment-trigger").click(function(w){if($(window).width()>600){w.preventDefault();$(".login-box .pane").hide();$("#comment-and-login").show();var h=$("#campaign-thread li:last-child .thread-item .num").text();$("#comment-form").append($("<input/>").attr("type","hidden").attr("name","last_thread_index").attr("class","last_thread_index").val(h));$("#login-box").dialog({title:$(".comment-trigger").attr("data-title")+":"});$("#login-box").dialog("open");return false}});$(".add-photos-trigger").click(function(h){if($(window).width()>600){h.preventDefault();$(".login-box .pane").hide();$("#campaign-add-photos").show();$("#login-box").dialog({title:"Add a photo"});$("#login-box").dialog("open");return false}});function f(x,h){$(x+" .error").html();$(x+" .error").hide();for(var w in h.errors){error_class=w.replace(".","_");$(x+" .error-"+error_class).html(h.errors[w]);$(x+" .error-"+error_class).show()}}function i(){var h={data:{_method:"post"},dataType:"json"};return h}function k(h){if($(window).width()>600){options=i();options.success=function(w){$("#login-landing .notice").text(w.notice);$("#login-landing .notice").show();$(".login-box .pane").hide();$("#login-box").dialog({title:"Sign In or Sign Up"});$("#login-landing").show();$("#login-box").dialog("open");_gaq.push(["_trackPageview",location.pathname+"/login"])};$(h).ajaxForm(options)}}function r(h){options=i();options.error=function(){o(h+" .error-text")};options.success=function(w){if(w.success){$("#login-box").dialog("close");$(h+" #campaign_update_text").val("");$(h+" .last_thread_index").remove();$(h+" #campaign_update_is_advice_request").remove();q(w.html)}else{f(h,w)}};$(h).ajaxForm(options)}function n(h){options=i();options.error=function(){o(h+" .error-text")};options.beforeSubmit=function(y,z,w){var x=$("#campaign-thread li:last-child .thread-item .num").text();y[y.length]={name:"last_thread_index",value:x}};options.success=function(w){if(w.success){$(h+" .error-text").html("");$(h+" .error-text").hide();$(h+" #campaign_update_text").val("");$(h+" #update-notice").html("Your update has been added to your problem history and will be sent to your supporters.");$(h+" #update-notice").fadeIn(1000,function(){$(this).delay(5000).fadeOut(1000)});$(h+" .last_thread_index").remove();q(w.html)}else{f(h,w)}};$(h).ajaxForm(options)}function o(h){$(h).html("There was a problem contacting the server. Please reload the page and try again.");$(h).show()}function u(h){options=i();options.error=function(){o(h+" .error-text")};options.success=function(w){if(w.success){if(w.requires_login){if($(window).width()>600){$("#login-create-account .notice").text(w.notice);$("#login-create-account .notice").show();$(".login-box .pane").hide();$("#login-box").dialog({title:"Create a FixMyTransport Account"});$("#login-create-account").fadeIn();$("#login-box").dialog("open");_gaq.push(["_trackPageview",location.pathname+"/login"])}else{window.location=w.redirect}}else{window.location=w.redirect}}else{f(h,w)}};$(h).ajaxForm(options)}function e(h){options=i();options.error=function(){o(h+" .error-text")};options.success=function(w){if(w.success){$(h+" #comment_text").val("");$(h+" #comment_mark_fixed").attr("checked",false);$(h+" #comment_mark_open").attr("checked",false);if(w.mark_fixed){$("#banner .container").append('<div class="right"><span class="ribbon">Fixed</span></div>')}if(w.mark_open){$("#banner .container .right").remove()}$(h+" .last_thread_index").remove();if(w.requires_login){$("#login-landing .notice").text(w.notice);$("#login-landing .notice").show();$(".login-box .pane").hide();$("#login-box").dialog({title:"Sign In or Sign Up"});$("#login-landing").show()}else{$("#login-box").dialog("close");$(".no-comments-text").hide();q(w.html)}}else{f(h,w)}};$(h).ajaxForm(options)}function q(h){$("#campaign-thread").append(h);var w=$("ul#campaign-thread li:last-child a.thread-item");w.click(function(x){x.preventDefault();d($(this).parent("li"))});w.click()}function j(h){options=i();options.error=function(){o(h+" #error-base")};options.success=function(w){if(w.success){if(w.redirect){window.location=w.redirect}else{if(w.html){$("#login-box").dialog("close");$("body").html(w.html)}else{window.location.reload()}}}else{f(h,w)}};$(h).ajaxForm(options)}r(".pane #campaign-update-form-modal");n("#campaign-update-form-static");u("#create-problem");e(".pane #comment-form");k(".login-to-support");j(".pane #login-form");j(".pane #create-account-form");j(".pane .password_reset_email");$(".twitter-popup").click(function(z){var x=575,h=400,B=($(window).width()-x)/2,A=($(window).height()-h)/2,w=this.href,y="status=1,width="+x+",height="+h+",top="+A+",left="+B;window.open(w,"twitter",y);return false});$(".facebook-login").click(callFacebook);$(".tipbox").prepend('<div class="tip-nub"></div>');$(".form-1 input, .form-1 textarea").focus(function(){var h=$(this).parent();$(".tipbox").not(".fixed").css({right:"-999999em"});$(".tipbox",h).not(".fixed").css({right:"-350px",opacity:"0"}).animate({opacity:"1"},{duration:500,queue:false})});$(".tip-close").click(function(h){h.preventDefault();$(".tipbox").not(".fixed").animate({opacity:"0"},{duration:500,queue:false})});if($(".gallery a").length>0){$(".gallery a").lightBox({imageLoading:"/images/lightbox-ico-loading.gif",imageBtnClose:"/images/lightbox-btn-close.gif",imageBtnPrev:"/images/lightbox-btn-prev.gif",imageBtnNext:"/images/lightbox-btn-next.gif"})}if($(".campaign-content ul#campaign-thread li a.thread-item span.title").length>0&&$(window).width()>600){$(".campaign-content ul#campaign-thread li a.thread-item span.title").ellipsis()}function l(h){var z=h.find(".thread-copy");var y=h.find(".thread-alternative-copy");var w=z.html();var x=y.html();z.html(x);y.html(w);z.find(".unfold_link").click(function(A){A.preventDefault();l($(this).parents(".thread-details"))})}$("#campaign-thread .unfold_link").click(function(h){h.preventDefault();l($(this).parents(".thread-details"))});$("#campaign-supporters .view-all").click(function(h){h.preventDefault();$.ajax({url:$(this).attr("url"),success:function(w){$("#campaign-supporters").html(w)}})});if($("#other-country-notice").length>0){$.ajax({url:"/request_country",dataType:"html",success:function(h){if(h!="GB"){$("#other-country-notice").html("Hola! Bonjour! Howdy! We have an <a href='advice'>important message for visitors from outside Great Britain </a>");$("#conditional-notice").show()}}})}});function externalAuth(b){var a=window.location.protocol+"//"+window.location.host+"/user_sessions/external";var c=$('<form action="'+a+'" method="POST"></form>');for(authParam in b){c.append($('<input type="hidden" name="'+authParam+'" value="'+b[authParam]+'">'))}c.append($('<input type="hidden" name="path" value="'+window.location.pathname+window.location.search+'">'));$("body").append(c);c.submit()}window.fbAsyncInit=function(){FB.init({appId:fmt_facebook_app_id,status:false,cookie:false,xfbml:true,channelUrl:window.location.protocol+"//"+window.location.host+"/channel.html"});FB.getLoginStatus(function(a){if(a.session&&a.status&&a.status=="connected"){$(".facebook-login").unbind("click");$(".facebook-login").click(function(){facebookLogin(a)})}})};(function(){var a=document.createElement("script");a.async=true;a.src=document.location.protocol+"//connect.facebook.net/en_US/all.js";if(document.getElementById("fb-root")){document.getElementById("fb-root").appendChild(a)}}());function frontpageScroller(a,b){$('#frontpage-problem-scroller li:not(".hidden")').delay(a).fadeOut(b,function(){$(this).addClass("hidden");if($(this).hasClass("last")){$("#frontpage-problem-scroller li.first").removeClass("hidden").fadeIn(b,function(){frontpageScroller(a,b)})}else{$(this).next().removeClass("hidden").fadeIn(b,function(){frontpageScroller(a,b)})}})};
<%- content_for :javascript do %>
<%= raw javascript_include_tag('jquery.lightbox-0.5.min.js', :charset => 'utf-8') %>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>
<%= raw javascript_include_tag("http://use.typekit.com/ftq7gco.js")%>
<script type="text/javascript">try{Typekit.load();}catch(e){}</script>
<%- end %>
<%- content_for :stylesheets do %>
<%= stylesheet_link_tag 'jquery.lightbox-0.5.css'  %>
<%- end %>

<div id="banner" class="yellow container">
	<div class="leftcol-banner">
		<h1 class="tk-museo"><%= @campaign.title %></h1>
	</div>

	<div class="rightcol">

    <%- if current_user %>

      <%- if current_user.initiated_campaigns.include?(@campaign) %>

        Your campaign
        <%= campaign_display_status(@campaign) %>

      <%- elsif current_user.campaigns.include?(@campaign) %>
        You are a supporter of this campaign
          <%- form_for @campaign, :url => leave_campaign_url(@campaign), :html => { :method => 'POST' } do |f| %>
            <%= raw hidden_field_tag "user_id", current_user.id %>
            <%= raw submit_tag t(:leave_this_campaign) %>
          <%- end %>

      <%- else %>

        <%- form_for @campaign, :url => join_campaign_url(@campaign), :html => { :method => 'POST',  } do |f| %>
          <%= raw submit_tag "Support", :class => 'support-big' %>
        <%- end %>

      <%- end %>

    <%- else %>

      <%- form_for @campaign, :url => join_campaign_url(@campaign), :html => { :method => 'POST',  } do |f| %>
        <%= raw hidden_field_tag "next_action", @next_action_join %>
        <%= raw submit_tag "Support", :class => 'support-big', :id => 'login-to-support'%>
      <%- end %>
    
    <%- end %>
	</div>
</div>

<div id="main-content" class="container">

	<div class="leftcol">

	  <%- if current_user && current_user == @campaign.initiator %>
     <div class="campaign-initiator-actions">


      <%= render :partial => 'update_form', :locals => {  :hidden => true, :update => CampaignUpdate.new(:user_id => current_user.id) } %>

      <%- if @campaign.status != :successful %>
        <%- form_for @campaign, :url => complete_campaign_url(@campaign), :html => { :method => 'POST',  } do |f| %>
          <%= raw submit_tag "Mark as Complete", :class => 'action-button' %>
        <%- end %>
  	  <%- end %>

      <%= link_to "Add Image", add_photos_campaign_url(@campaign), :class => 'action-button'%>

      <%- if !@campaign.problem.optional_assignments.empty? or !@campaign.problem.assignments.is_new.empty? %>
        <div class="new-assignments">
            <%- @campaign.problem.assignments.is_new.each do |assignment| %>
               <%= render :partial => "shared/new_assignments/#{assignment.task_type}", :locals => { :assignment => assignment }%>
            <%- end %>
          </div>
        <div class='optional-assignments'>
          <%- @campaign.problem.optional_assignments.each do |assignment_type|
     %>
            <%= render :partial => "shared/optional_assignments/#{assignment_type}" %>
          <%- end %>
          <div class='optional-assignment-end'></div>
          <%= render :partial => 'update_form', :locals => { :hidden => true, :update => CampaignUpdate.new(:is_advice_request => true, :user_id => current_user.id) } %>
        </div>
      <%- end %>

      </div>
    <%- end %>




		<div class="box campaign-description">
		  <%- if !current_user || (current_user != @campaign.initiator) %>
			<img src="<%= @campaign.initiator.profile_photo.url(:medium_thumb) %>" class="avatar" />
			<%- end %>
			<div>
				<%- if !current_user || (current_user != @campaign.initiator) %>
				<h4><a href="<%= profile_url(@campaign.initiator) %>"><%= @campaign.initiator.name %></a></h4>
				<%- end %>

				<p><%= raw simple_format(sanitize(@campaign.description)) %>
				  <%- if current_user && (current_user == @campaign.initiator || current_user.is_expert?) %>
            <%= link_to(t(:edit), edit_campaign_path(@campaign), :class => 'description-edit-link') %>
          <%- end %>
				  <a href="#" class="more-info">more</a>
				  </p>
			</div>
		</div>


   <%- if current_user && current_user.is_expert? %>
     <div class="expert-actions">
     <h3><%= t(:transport_experts) %></h3>
     <div class='expert-actions'>
       <div class='optional-assignment'>
         <%= link_to(t(:tell_to_write, :user => @campaign.initiator.first_name), new_campaign_assignment_path(@campaign)) %>
       </div>
       <div class='optional-assignment-end'>
       </div>
     </div>
     </div>
   <%- end %>

    <%- if @campaign.campaign_photos.count > 0 %>
		<div class="box">
			<h5>Images and Media</h5>
			<ul class="gallery grey">
			  <%- @campaign.campaign_photos.each do |campaign_photo| %>
				  <li><a href="<%= campaign_photo.image.url(:max) %>"><img src="<%= campaign_photo.image.url(:default) %>" /></a></li>
				<%- end %>
			</ul>
		</div>
		<%- end %>

		<div class="box">
			<a class="comment-button right" href="<%= add_comment_campaign_url(@campaign) %>">Comment</a>
		</div>

		<div class="clear">
			<h3 class='left latest-news'><%= t(:latest_news) %></h3>
			<div class="thread-controls">
				<a href="#" class="expand-all">Expand All</a>
				<a href="#" class="collapse-all">Collapse All</a>
				<a href="#" class="sort">Sort</a>
			</div>
		</div>
		<ul id="campaign-thread">
		<%- @campaign.campaign_events.visible.each_with_index do |campaign_event, index| %>
			<%= render :partial => 'campaign_event', :locals => { :event => campaign_event, :index => index+1 } %>
		<%- end %>
		</ul>

		<a class="right support" href="#">Support</a>


</div>


	<div class="rightcol">
		<ul class="campaign-meta">
			<li>started <span><%= @campaign.created_at.strftime("%e %B %Y") %></span></li>
			<li>supporters <%=  @campaign.supporter_count %></li>
		</ul>

		<%- if @campaign.location %>
		<div id="map-container">
			<div id="small-map">
			  <%= render :partial => 'shared/map', :locals => { :locations => [@campaign.location], :other_locations => [], :link_type => :location, :height => CAMPAIGN_PAGE_MAP_HEIGHT, :width => CAMPAIGN_PAGE_MAP_WIDTH, :static => true } %>
		  </div>
		  <%- unless @campaign.location.is_a?(SubRoute) %>
      <a class="grey-button right" href="<%= location_url(@campaign.location) %>">Larger Map</a>
      <%- end %>
		</div>
		<%- end %>


		<div class="box">
			<h5>Campaign Manager</h5>
			<div class="grey">
				<div class="avatar"><img src="<%= @campaign.initiator.profile_photo.url(:large_thumb) %>" /></div>
				<div class="user-info">
					<a class="name" href="<%= profile_url(@campaign.initiator) %>"><%= @campaign.initiator.name %></a>
					<%- if @campaign.initiator.location %>
					<p class="location"><%= @campaign.initiator.location %></p>
					<%- end %>
					<p>Managing <a href="<%= profile_url(@campaign.initiator, :anchor => "managing") %>"><%= pluralize(@campaign.initiator.initiated_campaigns.count, 'Campaign') %></a></p>
					<p>Supporting <a href="<%= profile_url(@campaign.initiator, :anchor => "supporting") %>"><%= pluralize(@campaign.initiator.campaigns.count, 'Campaign') %></a></p>
				</div>
			</div>
		</div>

		<%- if @campaign.supporters.registered.count > 0 %>
		  <%= render :partial => "supporters", :locals => {:show_all => (params[:all_supporters] == '1') }%>
		<%- end %>
	</div>

	<div class="container">
		<a href="#top" class="goto-top right">Top of page</a>
	</div>
</div>